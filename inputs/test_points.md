# 【进行中】VP测试账户屏蔽商品类目+下单传支付渠道参数改造.md

## 一、商品名称屏蔽转换逻辑

### 1️⃣ 支付渠道触发范围

仅对卡渠道（信用卡）和电子钱包类支付生效

明确排除XT、电汇、余额支付三类渠道

需确认XT是否含子类型（如XT-USD/XT-EUR），若存在需覆盖子类型校验

⚠️ 隐藏雷点提示

- 需求未明确定义‘卡渠道’和‘电子钱包’的具体枚举值，需确认支付渠道编码体系（如Visa/Mastercard/Alipay/Stripe等）是否全部纳入屏蔽范围

### 2️⃣ 屏蔽关键词匹配逻辑

支持中英文商品名称全字段模糊匹配（非前缀/后缀限定）

关键词匹配不区分大小写

多个关键词命中时，按TMS配置优先级最高者执行替换

商品名称含空格、标点、emoji时仍可正常匹配

⚠️ 边界点

- 超长商品名称（>255字符）下关键词截断匹配行为未定义，需确认TMS返回关键词长度限制及截断策略

### 3️⃣ TMS禁用品名替换配置查询

下单时实时调用TMS接口获取最新配置

配置缓存机制需明确：无缓存 / TTL固定 / 变更主动推送

TMS接口返回空配置时，默认不执行屏蔽

TMS返回格式异常（如JSON结构错误）时降级为原始名称透传

⚠️ 隐藏雷点提示

- 需求未说明TMS配置是否支持多语言关键词、是否支持正则表达式、是否支持SPU级与SKU级差异化配置，需确认

## 二、屏蔽处理与参数透传

### 1️⃣ 替换规则执行

命中关键词后，使用TMS配置中指定的‘替换后名称’覆盖原始商品名称

替换后名称长度超过下游系统限制（如支付网关≤50字符）时需截断并记录告警

同一订单含多个SKU时，各SKU独立执行屏蔽判断与替换

### 2️⃣ 原始名称透传路径

未命中关键词时，100%透传原始商品名称（含空格、括号、Unicode字符）

原始名称中含控制字符（如\u0000）时保留原样透传

SPU名称与SKU名称不一致时，以实际下单SKU名称为准进行匹配

⚠️ 边界点

- 原始商品名称含不可见Unicode字符（如ZWSP、LRM）时，匹配与透传行为未定义，需确认清洗策略

## 三、异常与容错机制

### 1️⃣ TMS接口超时与失败

TMS接口超时阈值需明确（当前需求仅写‘需明确’）

超时或HTTP非2xx响应时，自动跳过屏蔽逻辑，透传原始名称

失败日志需记录TMS请求ID、时间戳、支付渠道、商品SKU

失败不影响订单创建、库存锁定、支付发起等主流程

⚠️ 隐藏雷点提示

- 需求未定义超时具体数值（如1s/3s/5s），也未说明重试策略（0次/1次/指数退避），需确认

### 2️⃣ 并发与数据一致性

高并发下单场景下，TMS配置变更（如新增关键词）需保证单次请求内原子性

同一SKU在毫秒级内被多次下单，屏蔽结果应保持一致（避免因缓存不一致导致部分订单屏蔽、部分不屏蔽）

## 四、跨境特有风险覆盖

### 1️⃣ 多语言与本地化

英文商品名称命中英文关键词，中文名称命中中文关键词，互不干扰

TMS配置支持按语言标签（lang=zh/en/ja等）加载对应关键词集

商品名称含混合语言（如‘iPhone 15 Pro (国行版)’）时，按完整字符串匹配

⚠️ 隐藏雷点提示

- 需求未说明TMS是否支持区域化配置（如US站禁用词 vs EU站禁用词），需确认站点维度隔离能力

### 2️⃣ 物流合规关联

屏蔽后的商品名称需与TMS中禁运品分类映射一致（如‘lithium battery’→‘危险品’）

替换名称不得引入新合规风险（如将‘vape’替换为‘e-cig’仍属禁运）

## 五、权限与数据安全

### 1️⃣ 敏感信息防护

屏蔽逻辑仅作用于下单传参环节，后台数据库、商品管理列表、导出文件中仍保存原始名称

API响应体、日志、监控指标中不得明文打印原始商品名称（当命中屏蔽时）

审计日志需记录‘原始名称→替换名称’映射关系，且仅限管理员可见
